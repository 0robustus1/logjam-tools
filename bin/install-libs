#!/bin/bash
set -e

cd builds

case $OSTYPE in
    darwin*)
        CC=clang
        CXX=clang++
        ldconfig=/usr/bin/true
        ;;
    *)
        CC=gcc
        CXX=g++
        ldconfig=ldconfig
        ;;
esac

test -z "$LSUDO" && LSUDO="sudo"

export CC CXX

d=rabbitmq-c-0.5.2
f=${d}.tar.gz
test -f $f || wget -nv https://github.com/alanxz/rabbitmq-c/releases/download/v0.5.2/$f
test -d $d || tar xzvf $f
cd $d
test -f config.status || ./configure
make
$LSUDO make install
$LSUDO $ldconfig
cd ..

d=libsodium-1.0.0
f=${d}.tar.gz
test -f $f || wget -nv https://github.com/jedisct1/libsodium/releases/download/1.0.0/$f
test -d $d || tar xzvf $f
cd $d
test -f config.status || ./configure
make
$LSUDO make install
$LSUDO $ldconfig
cd ..

d=zeromq-4.0.5
f=${d}.tar.gz
test -f $f || wget -nv http://download.zeromq.org/$f
test -d $d || tar xzvf $f
cd $d
test -f config.status || ./configure
make
$LSUDO make install
$LSUDO $ldconfig
cd ..

d=czmq
test -d $d || git clone https://github.com/zeromq/${d}.git
cd $d
git reset --hard
git fetch
git checkout d7f4da8945b8bb022034c5ada3c6f1da5b9af351
test -f config.status || (sh autogen.sh && ./configure)
make
$LSUDO make install
$LSUDO $ldconfig
cd ..

d=mongo-c-driver
test -d $d || git clone https://github.com/mongodb/${d}.git
cd $d
git reset --hard
git fetch
git checkout 048c851919dc32c98b5f8a9a0270e69af9385db3
test -f config.status || (sh autogen.sh && ./configure --with-libbson=bundled)
make
$LSUDO make install
$LSUDO $ldconfig
cd ..

# json-c configure fails if it's not put in another sub dir. go figure.
test -d murks || mkdir murks
cd murks

d=json-c
test -d $d || git clone https://github.com/skaes/${d}.git
cd $d
git reset --hard
git fetch
git checkout 36be1c4c7ade78fae8ef67280cd4f98ff9f81016
test -f config.status || (sh autogen.sh && ./configure)
make
$LSUDO make install
$LSUDO $ldconfig
cd ../..

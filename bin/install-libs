#!/bin/bash
set -e

build_dir="builds/repos"
forced=0
prefix=/usr/local

test -z "$LSUDO" && LSUDO="sudo"
test "$(whoami)" = "root" && LSUDO=""

while (( $# > 0 )); do
    case "$1" in
        --help)
            echo "$0 [--force] [--build-dir dir] [--prefix dir] [install|uninstall]"; exit 0;;
        --force)
            forced=1; shift;;
        --build-dir)
            build_dir="$2"; shift 2;;
        --prefix )
            prefix="$2"; shift 2;;
        *) break ;;
    esac
done

if [ "$1" == "" ]; then
    cmd=install
else
    cmd=$1
    shift
fi

echo "library dependencies go into $prefix, forced=$forced, cmd=$cmd, build_dir=$build_dir"

mkdir -p $build_dir
cd $build_dir

case $OSTYPE in
    darwin*)
        export CC=clang
        export CXX=clang++
        ldconfig=/usr/bin/true
        ;;
    *)
        export CC=gcc
        export CXX=g++
        ldconfig=ldconfig
        ;;
esac

# setup pkgconfig path so that libzmq can find libsodium
# and libczmq can find libzmq
export PKG_CONFIG_PATH="$prefix/lib/pkgconfig:$PKG_CONFIG_PATH"

function handle_rabbitmq()
{
    d=rabbitmq-c
    test -d $d || git clone https://github.com/skaes/rabbitmq-c.git
    cd $d
    revision=$(git rev-parse HEAD)
    expected_revision="4a33bd4602740a88a4f00e7cad094fe736b3f38d" # use-std-gnu99
    if [ "$revision" != $expected_revision ]; then
        git reset --hard
        git fetch
        git checkout $expected_revision
    fi
    [ $forced == "1" ] && rm -f config.status
    test -f config.status || (autoreconf -i && ./configure --prefix=$prefix)
    [ $forced == "1" ] && make clean
    make
    $LSUDO make $cmd
    $LSUDO $ldconfig
    cd ..
}

function handle_mongoc()
{
    d=mongo-c-driver
    test -d $d || git clone https://github.com/mongodb/${d}.git
    cd $d
    revision=$(git rev-parse HEAD)
    expected_revision="89d779efd5a82e42ac2604f7af97c9acf2bcb8d0" # 1.1.10
    if [ "$revision" != "$expected_revision" ]; then
        git reset --hard
        git fetch
        git checkout $expected_revision
        git submodule update
    fi
    [ $forced == "1" ] && rm -f config.status
    test -f config.status || (sh autogen.sh && ./configure --prefix=$prefix --with-libbson=bundled)
    [ $forced == "1" ] && make clean
    make
    $LSUDO make $cmd
    $LSUDO $ldconfig
    cd ..
}

function handle_json_c()
{
    d=json-c
    test -d $d || git clone https://github.com/skaes/${d}.git
    cd $d
    revision=$(git rev-parse HEAD)
    expected_revision="36be1c4c7ade78fae8ef67280cd4f98ff9f81016"
    if [ "$revision" != $expected_revision ]; then
        git reset --hard
        git fetch
        git checkout $expected_revision
    fi
    [ $forced == "1" ] && rm -f config.status
    test -f config.status || (sh autogen.sh && ./configure --prefix=$prefix)
    [ $forced == "1" ] && make clean
    make
    $LSUDO make $cmd
    $LSUDO $ldconfig
    cd ..
}


function handle_sodium()
{
    d=libsodium-1.0.3
    f=${d}.tar.gz
    test -f $f || wget -nv https://github.com/jedisct1/libsodium/releases/download/1.0.3/$f
    test -d $d || tar xzvf $f
    cd $d
    [ $forced == "1" ] && rm -f config.status
    test -f config.status || ./configure --prefix=$prefix
    [ $forced == "1" ] && make clean
    make
    $LSUDO make $cmd
    $LSUDO $ldconfig
    cd ..
}

function handle_zeromq()
{
    d=zeromq-4.1.2
    f=${d}.tar.gz
    test -f $f || wget -nv http://download.zeromq.org/$f
    test -d $d || tar xzvf $f
    cd $d
    [ $forced == "1" ] && rm -f config.status
    test -f config.status || ./configure
    [ $forced == "1" ] && make clean
    make
    $LSUDO make $cmd
    $LSUDO $ldconfig
    cd ..
}

function handle_czmq()
{
    d=czmq
    test -d $d || git clone https://github.com/skaes/${d}.git
    cd $d
    revision=$(git rev-parse HEAD)
    expected_revision="e4af2e7850ad0cdb74429bb57b6fc9bd63869045" # 3.0.2
    if [ "$revision" != "" ]; then
        git reset --hard
        git fetch
        git checkout $expected_revision
    fi
    [ $forced == "1" ] && rm -f config.status
    test -f config.status || (sh autogen.sh && ./configure --prefix=$prefix)
    [ $forced == "1" ] && make clean
    make
    $LSUDO make $cmd
    $LSUDO $ldconfig
    cd ..
}

case $cmd in
    uninstall|clean)
        handle_czmq
        handle_zeromq
        handle_sodium
        handle_json_c
        handle_mongoc
        handle_rabbitmq
        ;;
    *)
        handle_rabbitmq
        handle_mongoc
        handle_json_c
        handle_sodium
        handle_zeromq
        handle_czmq
        ;;
esac
